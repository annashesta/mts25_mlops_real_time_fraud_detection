# ML Real time Fraud Detection Service

## Описание
Сервис для автоматического обнаружения мошеннических транзакций в режиме реального времени. Обрабатывает поток транзакций из Kafka с использованием предобученной модели CatBoost. Результаты сохраняются в PostgreSQL и доступны через веб-интерфейс.

## Архитектура решения
```
├── .gitignore
├── Dockerfile
├── README.md
├── app/
│ ├── app.py # Сервис для обработки транзакций из Kafka и записи результатов в Kafka
│ ├── score_loader.py # Сервис для загрузки результатов в PostgreSQL
│ └── web_app.py # Веб-приложение для отображения результатов
├── models/
│ └── catboost_model.cbm # Сохраненная модель CatBoost
├── src/
│ ├── preprocess.py # Пайплайн обработки данных
│ ├── scorer.py # Модуль прогнозирования
│ ├── feature_importance.py # Выгрузка важности признаков
│ └── plot_predictions.py # Построение графика плотности предсказаний
├── train_data/
│ └── train.csv # Данные для обучения (reference), необходимо скачать из соревнования
└── templates/
│ └── index.html # Шаблон для веб-приложения
└── logs/
└── config.yaml
└── requirements.txt
└── docker-compose.yml
```

## Ключевые особенности

### Многоуровневое логирование
- Регистрация всех событий в файл `/app/logs/service.log`
- Консольный вывод для мониторинга в реальном времени
- 3 уровня детализации:
  - `INFO`: Основные этапы обработки
  - `DEBUG`: Детали преобразования данных
  - `ERROR`: Критические сбои с трейсбэками

### Пайплайн обработки данных (`preprocessing.py`)
1. **Временные признаки**:
   - Извлечение часа, дня недели, месяца
   - Удаление исходного timestamp
   
2. **Геопространственные расчеты**:
   - Расчет расстояния (км) между клиентом и мерчантом
   - Использование формулы гаверсинусов

3. **Категориальные переменные**:
   - Группировка редких категорий (N+1 кодирование)
   - Mean-encoding с учетом целевой переменной

4. **Числовые признаки**:
   - Импутация средними значениями
   - Логарифмирование с добавлением эпсилон-коррекции

### Модельный слой (`scorer.py`)
- Порог классификации: 0.98
- Автоматическая загрузка модели при инициализации
- Батчевая обработка через `predict_proba`

## Быстрый старт

### Требования
- Docker 20.10+
- 2 ГБ свободного места

### Запуск сервиса

1. Скачайте файл `train.csv` из соревнования https://www.kaggle.com/competitions/teta-ml-1-2025 и разместите в директории `./train_data`
2. Соберите образы и запустите сервисы
```bash
docker-compose up --build
```

3. После запуска сервиса можно приступать к скорингу данных:
 - Отправьте сообщение в топик `transactions` Kafka в формате JSON:
```json
{
    "transaction_id": "12345",
    "transaction_time": "2023-10-01 12:00:00",
    "amount": 100.0,
    "gender": "M",
    "merch": "store1",
    "cat_id": "category1",
    "lat": 55.7558,
    "lon": 37.6173,
    "merchant_lat": 55.7522,
    "merchant_lon": 37.6156
}
```
 - Результаты скоринга будут отправлены в топик `scores` Kafka и сохранены в PostgreSQL.

4. Для просмотра результатов перейдите по адресу:
```
http://localhost:5000
```
